---
title: "Wisqars_v0.3"
author: "jackie cho"
format: pdf
editor: visual
---

Load Libraries

```{r}
# close all, clear all
rm(list=ls())
graphics.off()

# load tidyverse
library(tidyr)
library(tidyverse)
library(arrow)
library(dplyr)
library(ggplot2)
library(ggbeeswarm)
library(scales)
```

Load Dataset

```{r}
# load in file
ds1 <-vroom::vroom(
  "https://raw.githubusercontent.com/PopHIVE/Ingest/main/data/wisqars/standard/data.csv.gz",
  delim = ","
  )
# check if load in correctly
head(ds1)
```

Subset: Firearm

```{r}
# subset data
firearm = subset(ds1, select=c(geography, time, age, wisqars_rate_firearm_accident, wisqars_rate_firearm_intentional, wisqars_deaths_firearm_accident, wisqars_deaths_firearm_intentional))
```

FIPS

```{r}
# pull url for FIPS codes
url="https://www2.census.gov/geo/docs/reference/state.txt"
fips=read.delim(url,sep="|")

# change to double digits for 1-9
fips <- fips |>
  mutate(
    STATEFP = stringr::str_pad(STATE, width = 2, pad = "0")
  )

# create new column state name in firearm data set and match to fips df
firearm$state_name = fips$STATE_NAME[match(firearm$geography,fips$STATEFP)]

# add 00 = National
firearm$state_name[firearm$geography == "00"] <- "National"
```

Year: Time -\> Numberic

```{r}
# load library to convert time to year as numeric
library(lubridate)
# convert time to year as numeric
firearm$year <- year(ymd(firearm$time))
```

More Subsetting by Age Group

```{r}
# subset for only National values
firearm_national = firearm[which(firearm$state_name == "National"),]

# subset for each age group
firearm_national_0_14 = firearm_national[which(firearm_national$age == "0-14 Years"),]
firearm_national_15_24 = firearm_national[which(firearm_national$age == "15-24 Years"),]
firearm_national_25_44 = firearm_national[which(firearm_national$age == "25-44 Years"),]
firearm_national_45_64 = firearm_national[which(firearm_national$age == "45-64 Years"),]
firearm_national_25_44 = firearm_national[which(firearm_national$age == "25-44 Years"),]
firearm_national_65 = firearm_national[which(firearm_national$age == "65+ Years"),]
firearm_national_Total = firearm_national[which(firearm_national$age == "Total"),]
```

Top 5 States

```{r}
# subset firearm ft to only include Total ages
firearm_bystate_total = firearm[which(firearm$age == "Total"),]

# Aggregate both accidental and intentional firearm rates by year
firearm_bystate_avg <- aggregate(
  cbind(wisqars_rate_firearm_accident, wisqars_rate_firearm_intentional) ~ state_name,
  data = firearm_bystate_total,
  FUN = mean,
  na.rm = TRUE
)

# Identify Top 5 states in avg rate of intentional firearm deaths past 25 years
top5_intentional <- firearm_bystate_avg %>%
  group_by(state_name) %>%
  summarise(mean_intentional = mean(wisqars_rate_firearm_intentional, na.rm = TRUE)) %>%
  arrange(desc(mean_intentional)) %>%
  slice(1:5)

# Identify Top 5 states in avg rate of accidental firearm deaths past 25 years
top5_accidental <- firearm_bystate_avg %>%
  group_by(state_name) %>%
  summarise(mean_accident = mean(wisqars_rate_firearm_accident, na.rm = TRUE)) %>%
  arrange(desc(mean_accident)) %>%
  slice(1:5)
```

Top 5 States: Intentional Line Graph

```{r}
# Filter the Total-age dataset for top 5 intentional states
top5_intent_states <- top5_intentional$state_name

firearm_intent_top5 <- firearm_bystate_total %>%
  filter(state_name %in% top5_intent_states)

# Define consistent axis limits
year_min <- min(firearm_intent_top5$year, na.rm = TRUE)
year_max <- max(firearm_intent_top5$year, na.rm = TRUE)
rate_max <- max(firearm_intent_top5$wisqars_rate_firearm_intentional, na.rm = TRUE)

# Pick 5 distinct colors
colors <- c("red", "blue", "darkgreen", "purple", "orange")

# Plot the first state to create the base frame
first_state <- top5_intent_states[1]
data_first <- subset(firearm_intent_top5, state_name == first_state)

plot(
  data_first$year,
  data_first$wisqars_rate_firearm_intentional,
  type = "l",                # line plot
  lwd = 2,
  col = colors[1],
  xlim = c(year_min, year_max),
  ylim = c(0, rate_max),
  xlab = "Year",
  ylab = "Intentional Firearm Death Rate (per 100,000)",
  main = "Top 5 States: Intentional Firearm Death Rates (All Ages)\nOver Time"
)

# Add the remaining 4 states
for (i in 2:5) {
  state_data <- subset(firearm_intent_top5, state_name == top5_intent_states[i])
  lines(state_data$year, state_data$wisqars_rate_firearm_intentional, col = colors[i], lwd = 2)
}

# Add legend
legend("bottomright", legend = top5_intent_states, col = colors, lwd = 2, bty = "n")
```

Top 5 States: Accidental Line Graph

```{r}
# Filter for top 5 accidental states (from your earlier table)
top5_acc_states <- top5_accidental$state_name

# Keep only those 5 statesâ€™ data from the "Total" age group
firearm_acc_top5 <- firearm_bystate_total %>%
  filter(state_name %in% top5_acc_states)

# Consistent axis limits
year_min <- min(firearm_acc_top5$year, na.rm = TRUE)
year_max <- max(firearm_acc_top5$year, na.rm = TRUE)
rate_max <- max(firearm_acc_top5$wisqars_rate_firearm_accident, na.rm = TRUE)

# 5 distinct colors for clarity
colors <- c("red", "blue", "darkgreen", "purple", "orange")

# Base line plot using first state to set up axes
first_state <- top5_acc_states[1]
data_first <- subset(firearm_acc_top5, state_name == first_state)
data_first <- data_first[order(data_first$year), ]  # ensure sorted by year

plot(
  data_first$year,
  data_first$wisqars_rate_firearm_accident,
  type = "l",       # line graph
  lwd = 2,
  col = colors[1],
  xlim = c(year_min, year_max),
  ylim = c(0, rate_max),
  xlab = "Year",
  ylab = "Accidental Firearm Death Rate (per 100,000)",
  main = "Top 5 States: Accidental Firearm Death Rates (All Ages)\nOver Time"
)

# Add the other 4 states to the same plot
for (i in 2:5) {
  state_data <- subset(firearm_acc_top5, state_name == top5_acc_states[i])
  state_data <- state_data[order(state_data$year), ]  # sort by year
  lines(state_data$year, state_data$wisqars_rate_firearm_accident, col = colors[i], lwd = 2)
}

# Add legend
legend("topright", legend = top5_acc_states, col = colors, lwd = 2, bty = "n")

```

kk

```{r}
firearm_total_states <- firearm %>%
  filter(age == "Total", !is.na(state_name))
```

Intentional & Acc Rate by State

```{r}
ggplot(
  firearm_total_states,
  aes(x = year, y = wisqars_rate_firearm_intentional)
) +
  geom_point(alpha = 0.6, size = 1) +
  geom_smooth(method = "lm", se = FALSE, color = "blue", linewidth = 0.7) +
  facet_wrap(~ state_name) +
  labs(
    title    = "Intentional Firearm Death Rates Over Time",
    subtitle = "All Ages (Total), by State",
    x        = "Year",
    y        = "Intentional Firearm Death Rate (per 100,000)"
  ) +
  theme_bw(base_size = 10) +
  theme(
    strip.text = element_text(size = 8),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplot(
  firearm_total_states,
  aes(x = year, y = wisqars_rate_firearm_accident)
) +
  geom_point(alpha = 0.6, size = 1) +
  geom_smooth(method = "lm", se = FALSE, color = "blue", linewidth = 0.7) +
  facet_wrap(~ state_name) +
  labs(
    title    = "Accidental Firearm Death Rates Over Time",
    subtitle = "All Ages (Total), by State",
    x        = "Year",
    y        = "Accidental Firearm Death Rate (per 100,000)"
  ) +
  theme_bw(base_size = 8) +      # shrink everything overall
  theme(
    strip.text = element_text(size = 6),    # state names
    axis.text.x = element_text(size = 5),   # small x labels
    axis.text.y = element_text(size = 5),   # small y labels
    axis.title.x = element_text(size = 7),
    axis.title.y = element_text(size = 7),
    plot.title = element_text(size = 12),
    plot.subtitle = element_text(size = 9),
    strip.background = element_rect(fill = "grey90")
  )
```
