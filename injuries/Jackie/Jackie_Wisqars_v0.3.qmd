---
title: "Wisqars_v0.3"
author: "jackie cho"
format: pdf
editor: visual
---

Load Libraries

```{r}
# close all, clear all
rm(list=ls())
graphics.off()

# load tidyverse
library(tidyr)
library(tidyverse)
library(arrow)
library(dplyr)
library(ggplot2)
library(ggbeeswarm)
library(scales)
```

Load Dataset

```{r}
# load in file
ds1 <-vroom::vroom(
  "https://raw.githubusercontent.com/PopHIVE/Ingest/main/data/wisqars/standard/data.csv.gz",
  delim = ","
  )
# check if load in correctly
head(ds1)
```

Subset: Firearm

```{r}
# subset data
firearm = subset(ds1, select=c(geography, time, age, wisqars_rate_firearm_accident, wisqars_rate_firearm_intentional, wisqars_deaths_firearm_accident, wisqars_deaths_firearm_intentional))
```

FIPS

```{r}
# pull url for FIPS codes
url="https://www2.census.gov/geo/docs/reference/state.txt"
fips=read.delim(url,sep="|")

# change to double digits for 1-9
fips <- fips |>
  mutate(
    STATEFP = stringr::str_pad(STATE, width = 2, pad = "0")
  )

# create new column state name in firearm data set and match to fips df
firearm$state_name = fips$STATE_NAME[match(firearm$geography,fips$STATEFP)]

# add 00 = National
firearm$state_name[firearm$geography == "00"] <- "National"
```

Year: Time -\> Numberic

```{r}
# load library to convert time to year as numeric
library(lubridate)
# convert time to year as numeric
firearm$year <- year(ymd(firearm$time))
```

More Subsetting by Age Group

```{r}
# subset for only National values
firearm_national = firearm[which(firearm$state_name == "National"),]

# subset for each age group
firearm_national_0_14 = firearm_national[which(firearm_national$age == "0-14 Years"),]
firearm_national_15_24 = firearm_national[which(firearm_national$age == "15-24 Years"),]
firearm_national_25_44 = firearm_national[which(firearm_national$age == "25-44 Years"),]
firearm_national_45_64 = firearm_national[which(firearm_national$age == "45-64 Years"),]
firearm_national_25_44 = firearm_national[which(firearm_national$age == "25-44 Years"),]
firearm_national_65 = firearm_national[which(firearm_national$age == "65+ Years"),]
firearm_national_Total = firearm_national[which(firearm_national$age == "Total"),]
```

Top 5 States

```{r}
# subset firearm ft to only include Total ages
firearm_bystate_total = firearm[which(firearm$age == "Total"),]

# Aggregate both accidental and intentional firearm rates by year
firearm_bystate_avg <- aggregate(
  cbind(wisqars_rate_firearm_accident, wisqars_rate_firearm_intentional) ~ state_name,
  data = firearm_bystate_total,
  FUN = mean,
  na.rm = TRUE
)

# Identify Top 5 states in avg rate of intentional firearm deaths past 25 years
top5_intentional <- firearm_bystate_avg %>%
  group_by(state_name) %>%
  summarise(mean_intentional = mean(wisqars_rate_firearm_intentional, na.rm = TRUE)) %>%
  arrange(desc(mean_intentional)) %>%
  slice(1:5)

# Identify Top 5 states in avg rate of accidental firearm deaths past 25 years
top5_accidental <- firearm_bystate_avg %>%
  group_by(state_name) %>%
  summarise(mean_accident = mean(wisqars_rate_firearm_accident, na.rm = TRUE)) %>%
  arrange(desc(mean_accident)) %>%
  slice(1:5)
```

Top 5 States: Intentional Line Graph

```{r}
# Filter the Total-age dataset for top 5 intentional states
top5_intent_states <- top5_intentional$state_name

firearm_intent_top5 <- firearm_bystate_total %>%
  filter(state_name %in% top5_intent_states)

# Define consistent axis limits
year_min <- min(firearm_intent_top5$year, na.rm = TRUE)
year_max <- max(firearm_intent_top5$year, na.rm = TRUE)
rate_max <- max(firearm_intent_top5$wisqars_rate_firearm_intentional, na.rm = TRUE)

# Pick 5 distinct colors
colors <- c("red", "blue", "darkgreen", "purple", "orange")

# Plot the first state to create the base frame
first_state <- top5_intent_states[1]
data_first <- subset(firearm_intent_top5, state_name == first_state)

firearm_intent_top5$year <- as.integer(firearm_intent_top5$year)

ggplot(firearm_intent_top5, 
       aes(x = year, 
           y = wisqars_rate_firearm_intentional, 
           color = state_name,
           group = state_name)) +
  geom_line(linewidth = 1.2, alpha = 0.9) +
  geom_point(size = 1.5) +
  scale_color_brewer(palette = "Set1") +
  scale_x_continuous(breaks = seq(min(firearm_intent_top5$year, na.rm=TRUE),
                                  max(firearm_intent_top5$year, na.rm=TRUE),
                                  by = 2)) +
  labs(
    title = "Top 5 States: Intentional Firearm Death Rates (All Ages)\nOver Time",
    x = "Year",
    y = "Intentional Firearm Death Rate (per 100,000)",
    color = "State"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "right"
  )

```

Top 5 States: Accidental Line Graph

```{r}
# Filter for top 5 accidental states (from your earlier table)
top5_acc_states <- top5_accidental$state_name

# Keep only those 5 states’ data from the "Total" age group
firearm_acc_top5 <- firearm_bystate_total %>%
  filter(state_name %in% top5_acc_states)

# Consistent axis limits
year_min <- min(firearm_acc_top5$year, na.rm = TRUE)
year_max <- max(firearm_acc_top5$year, na.rm = TRUE)
rate_max <- max(firearm_acc_top5$wisqars_rate_firearm_accident, na.rm = TRUE)

# 5 distinct colors for clarity
colors <- c("red", "blue", "darkgreen", "purple", "orange")

# Base line plot using first state to set up axes
first_state <- top5_acc_states[1]
data_first <- subset(firearm_acc_top5, state_name == first_state)
data_first <- data_first[order(data_first$year), ]  # ensure sorted by year

firearm_acc_top5$year <- as.integer(firearm_acc_top5$year)

ggplot(firearm_acc_top5, 
       aes(x = year, 
           y = wisqars_rate_firearm_accident, 
           color = state_name,
           group = state_name)) +
  geom_line(linewidth = 1.2, alpha = 0.9) +
  geom_point(size = 1.5) +
  scale_color_brewer(palette = "Set1") +
  scale_x_continuous(breaks = seq(min(firearm_acc_top5$year, na.rm=TRUE),
                                  max(firearm_acc_top5$year, na.rm=TRUE),
                                  by = 2)) +
  labs(
    title = "Top 5 States: Accidental Firearm Death Rates (All Ages)\nOver Time",
    x = "Year",
    y = "Accidental Firearm Death Rate (per 100,000)",
    color = "State"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "right"
  )

```

kk

```{r}
firearm_total_states <- firearm %>%
  filter(age == "Total", !is.na(state_name))
```

Intentional & Acc Rate by State

```{r}
ggplot(
  firearm_total_states,
  aes(x = year, y = wisqars_rate_firearm_intentional)
) +
  geom_point(alpha = 0.6, size = 1) +
  geom_smooth(method = "lm", se = FALSE, color = "blue", linewidth = 0.7) +
  facet_wrap(~ state_name) +
  labs(
    title    = "Intentional Firearm Death Rates Over Time",
    subtitle = "All Ages (Total), by State",
    x        = "Year",
    y        = "Intentional Firearm Death Rate (per 100,000)"
  ) +
  theme_bw(base_size = 8) +      # shrink everything overall
  theme(
    strip.text = element_text(size = 6),    # state names
    axis.text.x = element_text(size = 5),   # small x labels
    axis.text.y = element_text(size = 5),   # small y labels
    axis.title.x = element_text(size = 7),
    axis.title.y = element_text(size = 7),
    plot.title = element_text(size = 12),
    plot.subtitle = element_text(size = 9),
    strip.background = element_rect(fill = "grey90")
  )

ggplot(
  firearm_total_states,
  aes(x = year, y = wisqars_rate_firearm_accident)
) +
  geom_point(alpha = 0.6, size = 1) +
  geom_smooth(method = "lm", se = FALSE, color = "blue", linewidth = 0.7) +
  facet_wrap(~ state_name) +
  labs(
    title    = "Accidental Firearm Death Rates Over Time",
    subtitle = "All Ages (Total), by State",
    x        = "Year",
    y        = "Accidental Firearm Death Rate (per 100,000)"
  ) +
  theme_bw(base_size = 8) +      # shrink everything overall
  theme(
    strip.text = element_text(size = 6),    # state names
    axis.text.x = element_text(size = 5),   # small x labels
    axis.text.y = element_text(size = 5),   # small y labels
    axis.title.x = element_text(size = 7),
    axis.title.y = element_text(size = 7),
    plot.title = element_text(size = 12),
    plot.subtitle = element_text(size = 9),
    strip.background = element_rect(fill = "grey90")
  )
```

Add Region Variable and Remove National

```{r}
firearm_all <- firearm %>%
  mutate(region = case_when(
    state_name %in% c("Illinois", "Indiana", "Iowa", "Kansas", "Michigan",
                      "Minnesota", "Missouri", "Nebraska", "North Dakota",
                      "Ohio", "South Dakota", "Wisconsin") ~ "Midwest",
    
    state_name %in% c("Connecticut", "Maine", "Massachusetts", "New Hampshire",
                      "New Jersey", "New York", "Pennsylvania", "Rhode Island",
                      "Vermont") ~ "Northeast",
    
    state_name %in% c("Alaska", "Arizona", "California", "Colorado", "Hawaii",
                      "Idaho", "Montana", "Nevada", "New Mexico", "Oregon",
                      "Utah", "Washington", "Wyoming") ~ "West",
    
    state_name %in% c("Alabama", "Arkansas", "Delaware", "District of Columbia",
                      "Florida", "Georgia", "Kentucky", "Louisiana", "Maryland",
                      "Mississippi", "North Carolina", "Oklahoma", "South Carolina",
                      "Tennessee", "Texas", "Virginia", "West Virginia") ~ "South",
    
    TRUE ~ "Other"
  ))

firearm_us <- firearm_all %>%
  filter(state_name == "National",
         age == "Total")          # keep only all-ages rows for US

firearm_st <- firearm_all %>%
  filter(state_name != "National", # drop national rows
         age == "Total",           # keep only all-ages rows
         year != 2025)  
```

Regional Trends Over Time

```{r}
# Intentional by US Region
region_trend_intent <- firearm_st %>%
  group_by(year, region) %>%
  summarise(
    mean_rate = mean(wisqars_rate_firearm_intentional, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(region_trend_intent,
       aes(x = year, y = mean_rate, color = region, group = region)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 2) +
  labs(
    title = "Intentional Firearm Death Rates by U.S. Region (All Ages)",
    x     = "Year",
    y     = "Rate per 100,000",
    color = "U.S. Region"
  ) +
  scale_color_manual(
    values = c(
      "Northeast" = "#1f78b4",
      "Midwest"   = "#33a02c",
      "South"     = "#e31a1c",
      "West"      = "#ff7f00",
      "Other"     = "grey50"
    )
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "right"
  )

# Accidental by US Region
region_trend_acc <- firearm_st %>%
  group_by(year, region) %>%
  summarise(
    mean_rate = mean(wisqars_rate_firearm_accident, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(region_trend_acc,
       aes(x = year, y = mean_rate, color = region, group = region)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 2) +
  labs(
    title = "Accidental Firearm Death Rates by U.S. Region (All Ages)",
    x     = "Year",
    y     = "Rate per 100,000",
    color = "U.S. Region"
  ) +
  scale_color_manual(
    values = c(
      "Northeast" = "#1f78b4",
      "Midwest"   = "#33a02c",
      "South"     = "#e31a1c",
      "West"      = "#ff7f00",
      "Other"     = "grey50"
    )
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "right"
  )
```

Each region vs. US Line Plots

```{r}

# New variable bc don't want to write out long wisqars variables
myvar <- "wisqars_rate_firearm_intentional"   

# US trend (
us_trend <- firearm_us %>%
  select(year, all_of(myvar)) %>%
  group_by(year) %>%
  summarise(us_value = mean(.data[[myvar]], na.rm = TRUE), .groups = "drop")

# Regional trend
region_trend <- firearm_st %>%
  group_by(year, region) %>%
  summarise(
    region_value = mean(.data[[myvar]], na.rm = TRUE),
    .groups = "drop"
  )

# Combine region + U.S. into a long format for plotting
region_with_us <- region_trend %>%
  left_join(us_trend, by = "year") %>%
  pivot_longer(
    cols = c(region_value, us_value),
    names_to = "series",
    values_to = "rate"
  ) %>%
  mutate(
    series = recode(series,
                    region_value = "Region",
                    us_value     = "United States")
  )

# Setting Colors
region_colors <- c(
  "Northeast" = "#1f78b4",
  "Midwest"   = "#33a02c",
  "South"     = "#e31a1c",
  "West"      = "#ff7f00"
)

# Plot
ggplot(region_with_us) +
  # REGION LINE — color depends on the region
  geom_line(data = subset(region_with_us, series == "Region"),
            aes(x = year, y = rate, color = region, group = region),
            linewidth = 1.2) +
  geom_point(data = subset(region_with_us, series == "Region"),
             aes(x = year, y = rate, color = region, group = region),
             size = 2) +

  # U.S. LINE — always black
  geom_line(data = subset(region_with_us, series == "United States"),
            aes(x = year, y = rate, group = region),
            color = "black", linewidth = 1) +
  geom_point(data = subset(region_with_us, series == "United States"),
             aes(x = year, y = rate, group = region),
             color = "black", size = 1.5) +

  # facet = 4 regions
  facet_wrap(~ region, ncol = 2) +

  labs(
    title = "Intentional Firearm Death Rates: Region vs U.S. (All Ages)",
    subtitle = "Colored line = Region; Black line = U.S. overall",
    x = "Year",
    y = "Rate per 100,000"
  ) +
  scale_color_manual(values = region_colors) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

Region vs. US (Intentional) with baseline

```{r}

# Merge & compute difference
region_vs_us <- region_trend %>%
  left_join(us_trend, by = "year") %>%
  mutate(diff = region_value - us_value)

ggplot(region_vs_us,
       aes(x = year, y = diff, color = region, group = region)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Intentional Firearm Death Rates: Region vs U.S. (All Ages)",
    subtitle = "Positive values = region above national average; negative = below",
    x = "Year",
    y = "Difference from U.S. Rate",
    color = "U.S. Region"
  ) +
  scale_color_manual(
    values = c(
      "Northeast" = "#1f78b4",
      "Midwest"   = "#33a02c",
      "South"     = "#e31a1c",
      "West"      = "#ff7f00",
      "Other"     = "grey50"
    )
  ) +
  theme_minimal(base_size = 14)
```

Top 10 - Intentional

```{r}
# Keep only all-ages rows, drop National and NAs
firearm_total_states <- firearm %>%
  filter(
    age == "Total",
    !is.na(state_name),
    state_name != "National",
    year != 2025
  ) %>%
  mutate(
    wisqars_rate_firearm_intentional = as.numeric(wisqars_rate_firearm_intentional),
    wisqars_rate_firearm_accident    = as.numeric(wisqars_rate_firearm_accident)
  )

intent_horserace <- firearm_total_states %>%
  select(state_name, year, rate = wisqars_rate_firearm_intentional) %>%
  group_by(year) %>%
  mutate(state_rank = rank(-rate, ties.method = "first")) %>%
  filter(state_rank <= 10)   # top 10 states per year (edit if needed)

ggplot(intent_horserace,
       aes(x = reorder(state_name, rate), y = rate, fill = factor(year))) +
  geom_col() +
  coord_flip() +
  facet_wrap(~ year, scales = "free_y") +
  labs(
    title = "Intentional Firearm Death Rates (All Ages)",
    subtitle = "Top States per Year",
    x = "State",
    y = "Rate per 100,000",
    fill = "Year"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(face = "bold"),
    legend.position = "bottom"
  )
```

Top 10 - Accidental

```{r}
acc_horserace <- firearm_total_states %>%
  select(state_name, year, rate = wisqars_rate_firearm_accident) %>%
  group_by(year) %>%
  mutate(state_rank = rank(-rate, ties.method = "first")) %>%
  filter(state_rank <= 10)

ggplot(acc_horserace,
       aes(x = reorder(state_name, rate), y = rate, fill = factor(year))) +
  geom_col() +
  coord_flip() +
  facet_wrap(~ year, scales = "free_y") +
  labs(
    title = "Accidental Firearm Death Rates (All Ages)",
    subtitle = "Top States per Year",
    x = "State",
    y = "Rate per 100,000",
    fill = "Year"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 8, face = "bold"),
    legend.position = "bottom"
  )
```

Use New Data Set (Gtrends, EPIC Cosmos, etc)

```{r}
# load data
ds2 <- read_parquet(
  "https://raw.githubusercontent.com/PopHIVE/Ingest/4d6fd7364be0ea50b5a2c641c9ca16e554783971/data/bundle_injury_overdose/dist/firearms_geography_source.parquet"
)

# change to double digits for 1-9
fips <- fips |>
  mutate(
    STATEFP = stringr::str_pad(STATE, width = 2, pad = "0")
  )

# create new column state name in firearm data set and match to fips df
ds2$State = fips$STATE_NAME[match(ds2$geography,fips$STATEFP)]

# add 00 = National
ds2$State[ds2$geography == "00"] <- "National"

# convert time to year as numeric
ds2$year <- year(ymd(ds2$time))
```

Extract Gtrends

```{r}
# Filter for gtrends
gtrends_shotgun <- ds2 %>%
  filter(source %in% "gtrends_shotgun")
gtrends_9mm <- ds2 %>%
  filter(source %in% "gtrends_9mm")

# Only state data
gtrends_shotgun_st <- gtrends_shotgun %>%
  filter(State != "National")

gtrends_9mm_st <- gtrends_9mm %>%
  filter(State != "National")

```

Aggregate

```{r}
# Keep only states (no National) and valid years
ds2_states <- ds2 %>%
  filter(State != "National", !is.na(State), !is.na(year))

# Collapse to one value per State-year for shotgun
gtrends_shotgun_year <- ds2_states %>%
  filter(source == "gtrends_shotgun") %>%
  group_by(State, year) %>%
  summarise(
    value = mean(value, na.rm = TRUE),
    .groups = "drop"
  )

# Collapse to one value per State-year for 9mm
gtrends_9mm_year <- ds2_states %>%
  filter(source == "gtrends_9mm") %>%
  group_by(State, year) %>%
  summarise(
    value = mean(value, na.rm = TRUE),
    .groups = "drop"
  )
```

Plots: Google Trends per Time

```{r}
ggplot(gtrends_shotgun_year,
       aes(x = year, y = value, group = State, color = State)) +
  geom_line(alpha = 0.6, linewidth = 1) +
  geom_point(alpha = 0.6, size = 1.2) +
  labs(
    title = "Google Searches for 'Shotgun' Over Time",
    subtitle = "Average yearly Google Trends index, all 50 states",
    x = "Year",
    y = "Search Interest (annual average)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplot(gtrends_9mm_year,
       aes(x = year, y = value, group = State, color = State)) +
  geom_line(alpha = 0.6, linewidth = 1) +
  geom_point(alpha = 0.6, size = 1.2) +
  labs(
    title = "Google Searches for '9mm' Over Time",
    subtitle = "Average yearly Google Trends index, all 50 states",
    x = "Year",
    y = "Search Interest (annual average)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

Top 5 States

```{r}
# pick top 5 states by overall average across years
top5_shotgun <- gtrends_shotgun_year %>%
  group_by(State) %>%
  summarise(overall_avg = mean(value, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(overall_avg)) %>%
  slice(1:5) %>%
  pull(State)

# keep only top 5
gtrends_shotgun_top5 <- gtrends_shotgun_year %>%
  filter(State %in% top5_shotgun)

# plot
ggplot(gtrends_shotgun_top5,
       aes(x = year, y = value, color = State, group = State)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Google Searches for 'Shotgun' Over Time (Top 5 States)",
    subtitle = "Annual average Google Trends index",
    x = "Year",
    y = "Search Interest (annual average)",
    color = "State"
  ) +
  theme_minimal(base_size = 13)

gtrends_9mm_year <- ds2_states %>%
  filter(source == "gtrends_9mm") %>%
  group_by(State, year) %>%
  summarise(value = mean(value, na.rm = TRUE), .groups = "drop")

top5_9mm <- gtrends_9mm_year %>%
  group_by(State) %>%
  summarise(overall_avg = mean(value, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(overall_avg)) %>%
  slice(1:5) %>%
  pull(State)

gtrends_9mm_top5 <- gtrends_9mm_year %>%
  filter(State %in% top5_9mm)

ggplot(gtrends_9mm_top5,
       aes(x = year, y = value, color = State, group = State)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Google Searches for '9mm' Over Time (Top 5 States)",
    subtitle = "Annual average Google Trends index",
    x = "Year",
    y = "Search Interest (annual average)",
    color = "State"
  ) +
  theme_minimal(base_size = 13)
```

Data Wrapper: Heatmap

```{r}
readr::write_csv(firearm, "firearm.csv")
readr::write_csv(firearm_bystate_avg, "firearm_bystate_avg.csv")

## Accidental Firearm Death Rates
## idk how to embed

```

Motor Vehicle Deaths: Subsetting & FIPS

```{r}
# subset data
mvc = subset(ds1, select=c(geography, time, age, wisqars_deaths_motor_vehicle_traffic))

# create new column state name in firearm data set and match to fips df
mvc$state_name = fips$STATE_NAME[match(mvc$geography,fips$STATEFP)]

# add 00 = National
mvc$state_name[mvc$geography == "00"] <- "National"

# convert time to year as numeric
mvc$year <- year(ymd(mvc$time))

```

Total & Aggregate & Heatmap

```{r}
# subset mvc to only include Total ages
mvc_bystate_total = mvc[which(mvc$age == "Total"),]

# Aggregate mvc deaths total by year
mvc_bystate_avg <- aggregate(
  cbind(wisqars_deaths_motor_vehicle_traffic) ~ state_name,
  data = mvc_bystate_total,
  FUN = mean,
  na.rm = TRUE
)

readr::write_csv(mvc_bystate_avg, "mvc_bystate_avg.csv")


## idk how to embed
```
